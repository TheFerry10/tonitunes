{% extends "base.html" %}
{% import "bootstrap/wtf.html" as wtf %}

{% block title %}Manage Playlist{% endblock %}

{% block page_content %}
<div id="notification" class="alert" style="display: none;"></div>
<div class="card wtf-form-card">
    <div class="card-body">
        <h5 class="card-title">Manage Playlist: {{ playlist.name }}</h5>

        <div class="form-group">
            <label for="song_search">Search Songs</label>
            <input
                type="text"
                id="song_search"
                class="form-control"
                placeholder="Search by artist, title, or album"
            />
        </div>
        <div>
            <table class="table table-hover table-bordered">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Artist</th>
                        <th>Album</th>
                        <th>Player</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="playlist_table_body">
                    <!-- Current playlist songs -->
                    {% for song in playlist.songs %}
                    <tr>
                        <td>{{ song.title }}</td>
                        <td>{{ song.artist }}</td>
                        <td>{{ song.album }}</td>
                        <td>
                            <audio controls>
                                <source src="/static/audio/{{ song.filename.split('/').pop() }}" type="audio/mpeg">
                                Your browser does not support the audio element.
                            </audio>
                        </td>
                        <td>
                            <button type="button" onclick="removeSongFromPlaylist('{{ playlist.id }}', '{{ song.id }}')" class="btn btn-danger btn-sm btn-action">Delete</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tbody id="search_results_body">
                    <!-- Search results will be dynamically populated -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const songSearchInput = document.getElementById('song_search');
    const playlistTableBody = document.getElementById('playlist_table_body');
    const searchResultsBody = document.getElementById('search_results_body');

    // Fetch and display songs based on search input
    songSearchInput.addEventListener('input', () => {
        const query = songSearchInput.value.trim();
        if (query.length < 2) {
            searchResultsBody.innerHTML = ''; // Clear search results for short queries
            return;
        }

        fetch(`/songs/search?q=${encodeURIComponent(query)}`)
            .then(response => {
                if (!response.ok) throw new Error('Failed to fetch songs');
                return response.json();
            })
            .then(data => {
                populateSearchResults(data);
            })
            .catch(error => {
                console.error('Error fetching songs:', error);
                showNotification('Failed to load songs. Please try again.', 'error');
            });
    });

    // Populate the search results table
    function populateSearchResults(songs) {
        searchResultsBody.innerHTML = ''; // Clear previous results
        songs.forEach(song => {
            const row = document.createElement('tr');

            // Title, Artist, Album cells
            const titleCell = document.createElement('td');
            titleCell.textContent = song.title;

            const artistCell = document.createElement('td');
            artistCell.textContent = song.artist;

            const albumCell = document.createElement('td');
            albumCell.textContent = song.album || 'Unknown';

            // Player cell
            const playerCell = document.createElement('td');
            const audioPlayer = document.createElement('audio');
            audioPlayer.controls = true;
            const audioSource = document.createElement('source');
            audioSource.src = `/static/audio/${song.filename.split('/').pop()}`;
            audioSource.type = 'audio/mpeg';
            audioPlayer.appendChild(audioSource);
            playerCell.appendChild(audioPlayer);

            // Action cell with "Add" button
            const actionCell = document.createElement('td');
            const addButton = document.createElement('button');
            addButton.className = 'btn btn-success btn-sm btn-action';
            addButton.textContent = 'Add';
            addButton.onclick = () => addSongToPlaylist('{{ playlist.id }}', song);

            actionCell.appendChild(addButton);

            // Append cells to the row
            row.appendChild(titleCell);
            row.appendChild(artistCell);
            row.appendChild(albumCell);
            row.appendChild(playerCell);
            row.appendChild(actionCell);

            // Append the row to the search results table
            searchResultsBody.appendChild(row);
        });
    }

    // Add a song to the playlist and update the table dynamically
    function addSongToPlaylist(playlistId, song) {
        fetch(`/api/playlists/${playlistId}/songs/${song.id}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => {
            if (!response.ok) throw new Error('Failed to add the song');
            return response.json();
        })
        .then(() => {
            addSongToTable(song);
            showNotification('Song added successfully!', 'success');
        })
        .catch(error => {
            console.error('Error adding song:', error);
            showNotification('Failed to add the song. Please try again.', 'error');
        });
    }

    // Add a new row to the playlist table
    function addSongToTable(song) {
        const newRow = document.createElement('tr');

        newRow.innerHTML = `
            <td>${song.title}</td>
            <td>${song.artist}</td>
            <td>${song.album || 'Unknown'}</td>
            <td>
                <audio controls>
                    <source src="/static/audio/${song.filename.split('/').pop()}" type="audio/mpeg">
                    Your browser does not support the audio element.
                </audio>
            </td>
            <td>
                <button type="button" onclick="removeSongFromPlaylist('{{ playlist.id }}', '${song.id}')" class="btn btn-danger btn-sm btn-action">Delete</button>
            </td>
        `;

        playlistTableBody.appendChild(newRow);
    }

    // Remove a song from the playlist and update the table dynamically
    function removeSongFromPlaylist(playlistId, songId) {
        fetch(`/api/playlists/${playlistId}/songs/${songId}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => {
            if (!response.ok) throw new Error('Failed to remove the song');
            const row = document.querySelector(`button[onclick="removeSongFromPlaylist('${playlistId}', '${songId}')"]`).closest('tr');
            if (row) row.remove();
            showNotification('Song removed successfully!', 'success');
        })
        .catch(error => {
            console.error('Error removing song:', error);
            showNotification('Failed to remove the song. Please try again.', 'error');
        });
    }

    function showNotification(message, type = "success") {
        const notification = document.getElementById("notification");
        notification.textContent = message;

        // Set the appropriate class based on the type
        notification.className = `alert alert-${type}`;
        notification.style.display = "block";

        // Automatically hide the notification after 3 seconds
        setTimeout(() => {
            notification.style.display = "none";
        }, 3000);
    }
</script>
{% endblock %}
