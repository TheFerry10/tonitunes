{% extends "base.html" %}
{% import "bootstrap/wtf.html" as wtf %}

{% block title %}Manage Playlist{% endblock %}

{% block page_content %}
<div class="container">
    <!-- Notification Section -->
    <div id="notification" class="alert" style="display: none;"></div>
    <!-- Playlist Section -->
    <div class="playlist-section py-4">
        <div class="d-flex align-items-center mb-3">
            <img src="/static/images/playlist-cover.jpg" alt="Playlist Cover" class="img-thumbnail" style="width: 100px; height: 100px;">
            <div class="ms-3">
                <h1 class="mb-1">{{ playlist.name }}</h1>
                <p class="text-muted mb-0">{{ playlist.songs_in_playlist }} songs â€¢ <span id="playlist-duration"></span></p>
            </div>
        </div>
        <table class="table table-striped">
            <tbody>
            {% for song in playlist.songs %}
            <tr id="song-row-{{ song.id }}">
                <td>
                    {{ playlist.get_position_by_id(song.id) + 1}}
                </td>
                <td>
                <img src="/static/images/song-cover.jpg" alt="Song Cover" class="img-thumbnail" style="width: 50px; height: 50px;">
                </td>
                <td>
                    <div class="song-title">
                        <p class="mb-0">{{ song.title }}</p>
                        <div class="song-artist">
                            <p class="mb-0">{{ song.artist }}</p>
                        </div>
                    </div>
                </td>
                <td>{{ song.album }}</td>
                <td id="song-duration-{{ song.id }}"></td>
                <td>
                    <audio controls style="width: 150px;">
                        <source src="/static/audio/{{ song.filename.split('/')|last }}" type="audio/mpeg">
                        Your browser does not support the audio element.
                    </audio>
                </td>
                <td>
                <button type="button" class="btn btn-danger btn-sm remove-song-btn" data-playlist-id="{{ playlist.id }}" data-song-id="{{ song.id }}">
                    <i class="bi bi-trash"></i>
                </button>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Add Songs Section -->
    <div class="add-songs-section py-4">
        <h3>Add Songs</h3>
        <div class="form-group mb-3">
            <input
                type="text"
                id="song_search"
                class="form-control"
                placeholder="Search for songs..."
            />
        </div>
        <table class="table table-striped">
            <tbody id="search_results_body">
                <!-- Search results will be dynamically populated -->
            </tbody>
        </table>
    </div>
</div>

<script>
    const songSearchInput = document.getElementById('song_search');
    const playlistTableBody = document.getElementById('playlist_table_body');
    const searchResultsBody = document.getElementById('search_results_body');

    // Fetch and display songs based on search input
    songSearchInput.addEventListener('input', () => {
        const query = songSearchInput.value.trim();
        if (query.length < 2) {
            searchResultsBody.innerHTML = ''; // Clear search results for short queries
            return;
        }

        fetch(`/songs/search?q=${encodeURIComponent(query)}`)
            .then(response => {
                if (!response.ok) throw new Error('Failed to fetch songs');
                return response.json();
            })
            .then(data => {
                populateSearchResults(data);
            })
            .catch(error => {
                console.error('Error fetching songs:', error);
                showNotification('Failed to load songs. Please try again.', 'error');
            });
    });


    // Populate the search results table
    function populateSearchResults(songs) {
        const searchResultsBody = document.getElementById('search_results_body');
        searchResultsBody.innerHTML = ''; // Clear previous results

        songs.forEach(song => {
            const newRow = document.createElement('tr');

            newRow.innerHTML = `
                <td>
                    <img src="/static/images/song-cover.jpg" alt="Song Cover" class="img-thumbnail" style="width: 50px; height: 50px;">
                </td>
                <td>
                    <div class="song-title">
                        <p class="mb-0">${song.title}</p>
                        <div class="song-artist">
                            <p class="mb-0">${song.artist}</p>
                        </div>
                    </div>
                </td>
                <td>${song.album}</td>
                <td>${formatDurationMinutesSeconds(song.duration)}</td>
                <td>
                    <button type="button" class="btn btn-success btn-sm" onclick="addSongToPlaylist('{{ playlist.id }}', '${song.id}')">
                        <i class="bi bi-plus"></i>
                    </button>
                </td>
            `;

            searchResultsBody.appendChild(newRow);
        });
    }

    // Add a song to the playlist and update the table dynamically
    function addSongToPlaylist(playlistId, songId) {
        fetch(`/api/playlists/${playlistId}/songs/${songId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => {
            if (!response.ok) throw new Error('Failed to add the song');
            return response.json();
        });
    }

    // Add a new row to the playlist table
    function addSongToTable(song) {
        const newRow = document.createElement('tr');

        newRow.innerHTML = `
            <td>${song.title}</td>
            <td>${song.artist}</td>
            <td>${song.album}</td>
            <td>
                <audio controls>
                    <source src="/static/audio/${song.filename.split('/').pop()}" type="audio/mpeg">
                    Your browser does not support the audio element.
                </audio>
            </td>
            <td>
                <button type="button" onclick="removeSongFromPlaylist('{{ playlist.id }}', '${song.id}')" class="btn btn-danger btn-sm btn-action">Delete</button>
            </td>
        `;

        playlistTableBody.appendChild(newRow);
    }

    // Remove a song from the playlist and update the table dynamically
    function removeSongFromPlaylist(playlistId, songId) {
        fetch(`/api/playlists/${playlistId}/songs/${songId}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => {
            if (!response.ok) throw new Error('Failed to remove the song');
            const row = document.getElementById(`song-row-${songId}`);
            if (row) row.remove();
            showNotification('Song removed successfully!', 'success');
        })
        .catch(error => {
            console.error('Error removing song:', error);
            showNotification('Failed to remove the song. Please try again.', 'error');
        });
    }

    function showNotification(message, type = "success") {
        const notification = document.getElementById("notification");
        if (!notification) {
            console.error("Notification element not found");
            return;
        }

        notification.textContent = message;

        // Set the appropriate class based on the type
        notification.className = `alert alert-${type}`;
        notification.style.display = "block";

        // Automatically hide the notification after 3 seconds
        setTimeout(() => {
            notification.style.display = "none";
        }, 3000);
    }

    function formatDuration(duration_ms) {
        const hours = Math.floor(duration_ms / (1000 * 60 * 60));
        const minutes = Math.floor((duration_ms % (1000 * 60 * 60)) / (1000 * 60));
        return `${hours} hr ${minutes} min`;
    }

    function formatDurationMinutesSeconds(duration_ms) {
        const hours = Math.floor(duration_ms / (1000 * 60 * 60));
        const minutes = Math.floor((duration_ms % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((duration_ms % (1000 * 60)) / 1000);

        if (hours > 0) {
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        } else {
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
    }

    // Update the playlist duration on page load
    document.addEventListener('DOMContentLoaded', () => {
        const durationMs = {{ playlist.duration }};
        const formattedDuration = formatDuration(durationMs);
        document.getElementById('playlist-duration').textContent = formattedDuration;

        {% for song in playlist.songs %}
        {
            let songDurationElement = document.getElementById('song-duration-{{ song.id }}');
            if (songDurationElement) {
                songDurationElement.textContent = formatDurationMinutesSeconds({{ song.duration }});
            }
        }
        {% endfor %}

        // Attach event listeners to remove buttons
        document.querySelectorAll('.remove-song-btn').forEach(button => {
            button.addEventListener('click', () => {
                const playlistId = button.getAttribute('data-playlist-id');
                const songId = button.getAttribute('data-song-id');
                removeSongFromPlaylist(playlistId, songId);
            });
        });
    });
</script>
{% endblock %}
