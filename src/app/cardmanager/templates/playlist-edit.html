{% extends "base.html" %}
{% import "bootstrap/wtf.html" as wtf %}

{% block title %}Playlist{% endblock %}

{% block page_content %}
<div id="notification" class="alert" style="display: none;"></div>
<div class="card wtf-form-card">
    <div class="card-body">
        <h5 class="card-title">Playlist {{ playlist.name }}</h5>
        <table class="table">
            <thead>
                <tr>
                    <th>Artist</th>
                    <th>Title</th>
                    <th>Album</th>
                    <th>Player</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="playlist_table_body">
                {% for song in playlist.songs %}
                <tr>
                    <td>{{ song.artist }}</td>
                    <td>{{ song.title }}</td>
                    <td>{{ song.album }}</td>
                    <td>
                        <audio controls>
                            <source src="/static/audio/{{ song.filename.split('/').pop() }}" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio>
                    </td>
                    <td>
                        <button type="button" onclick="removeSongFromPlaylist('{{ playlist.id }}', '{{ song.id }}')" class="btn btn-danger btn-sm">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="card wtf-form-card mt-4">
    <div class="card-body">
        <h5 class="card-title">Add Songs</h5>
        <div class="form-group">
            <label for="song_search">Search Songs</label>
            <input
                type="text"
                id="song_search"
                class="form-control"
                placeholder="Search by artist, title, or album"
            />
        </div>
        <div class="form-group">
            <label for="song_results">Results</label>
            <div style="max-height: 300px; overflow-y: auto;">
                <table class="table table-hover table-bordered">
                    <thead>
                        <tr>
                            <th>Select</th>
                            <th>Artist</th>
                            <th>Title</th>
                            <th>Album</th>
                        </tr>
                    </thead>
                    <tbody id="song_results">
                        <!-- Results will be populated dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
        <button id="add_songs_button" class="btn btn-success">Add Songs</button>
    </div>
</div>

<script>
    const songSearchInput = document.getElementById('song_search');
    const songResultsTable = document.getElementById('song_results');
    const addSongsButton = document.getElementById('add_songs_button');
    const playlistTableBody = document.getElementById('playlist_table_body');
    let selectedSongs = [];

    // Fetch and display songs based on search input
    songSearchInput.addEventListener('input', () => {
        const query = songSearchInput.value.trim();
        if (query.length < 2) return; // Avoid unnecessary requests for short queries

        fetch(`/songs/search?q=${encodeURIComponent(query)}`)
            .then(response => {
                if (!response.ok) throw new Error('Failed to fetch songs');
                return response.json();
            })
            .then(data => {
                populateSongResults(data);
            })
            .catch(error => {
                console.error('Error fetching songs:', error);
                alert('Failed to load songs. Please try again later.');
            });
    });

    // Populate the song results table
    function populateSongResults(songs) {
        songResultsTable.innerHTML = ''; // Clear previous results
        songs.forEach(song => {
            const row = document.createElement('tr');

            // Checkbox for selection
            const selectCell = document.createElement('td');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = song.id;
            checkbox.addEventListener('change', () => {
                if (checkbox.checked) {
                    selectedSongs.push(song);
                } else {
                    selectedSongs = selectedSongs.filter(s => s.id !== song.id);
                }
            });
            selectCell.appendChild(checkbox);

            // Artist, Title, Album cells
            const artistCell = document.createElement('td');
            artistCell.textContent = song.artist;

            const titleCell = document.createElement('td');
            titleCell.textContent = song.title;

            const albumCell = document.createElement('td');
            albumCell.textContent = song.album || 'Unknown';

            // Append cells to the row
            row.appendChild(selectCell);
            row.appendChild(artistCell);
            row.appendChild(titleCell);
            row.appendChild(albumCell);

            // Append the row to the table
            songResultsTable.appendChild(row);
        });
    }

    // Add selected songs to the playlist
    addSongsButton.addEventListener('click', () => {
        if (selectedSongs.length === 0) {
            showNotification('No songs selected', 'error');
            return;
        }

        const playlistId = '{{ playlist.id }}';
        const songIds = selectedSongs.map(song => song.id);

        fetch(`/api/playlists/${playlistId}/songs`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ song_ids: songIds })
        })
            .then(response => {
                if (!response.ok) throw new Error('Failed to add songs');
                return response.json();
            })
            .then(() => {
                selectedSongs.forEach(song => addSongToTable(song));
                selectedSongs = []; // Clear selection
                showNotification('Songs added successfully!', 'success');
            })
            .catch(error => {
                console.error('Error adding songs:', error);
                showNotification('Failed to add songs. Please try again.', 'error');
            });
    });

    // Add a new row to the playlist table
    function addSongToTable(song) {
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td>${song.artist}</td>
            <td>${song.title}</td>
            <td>${song.album || 'Unknown'}</td>
            <td>
                <audio controls>
                    <source src="/static/audio/${song.filename ? song.filename.split('/').pop() : ''}" type="audio/mpeg">
                    Your browser does not support the audio element.
                </audio>
            </td>
            <td>
                <button type="button" onclick="removeSongFromPlaylist('{{ playlist.id }}', '${song.id}')" class="btn btn-danger btn-sm">Delete</button>
            </td>
        `;

        playlistTableBody.appendChild(newRow);
    }

    // Remove a song from the playlist and update the table dynamically
    function removeSongFromPlaylist(playlistId, songId) {
        fetch(`/api/playlists/${playlistId}/songs/${songId}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => {
            if (response.ok) {
                const row = document.querySelector(`button[onclick="removeSongFromPlaylist('${playlistId}', '${songId}')"]`).closest('tr');
                if (row) row.remove();
            } else {
                throw new Error('Failed to remove the song');
            }
        })
        .catch(error => {
            console.error('Error removing song:', error);
            alert('Failed to remove the song. Please try again.');
        });
    }

    function showNotification(message, type = "success") {
        const notification = document.getElementById("notification");
        notification.textContent = message;

        // Set the appropriate class based on the type
        notification.className = `alert alert-${type}`;
        notification.style.display = "block";

        // Automatically hide the notification after 3 seconds
        setTimeout(() => {
            notification.style.display = "none";
        }, 3000);
    }
</script>
{% endblock %}
